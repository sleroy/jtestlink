<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<body>
	<div th:fragment="requirementSample">													
           <div itemprop="articleBody">
            
  <div class="section" id="working-with-trees-in-django-forms">
<h1><a class="toc-backref" href="#id2">Working with trees in Django forms</a><a class="headerlink" href="#working-with-trees-in-django-forms" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#working-with-trees-in-django-forms" id="id2">Working with trees in Django forms</a><ul>
<li><a class="reference internal" href="#fields" id="id3">Fields</a><ul>
<li><a class="reference internal" href="#treenodechoicefield" id="id4"><code class="docutils literal"><span class="pre">TreeNodeChoiceField</span></code></a></li>
<li><a class="reference internal" href="#treenodemultiplechoicefield" id="id5"><code class="docutils literal"><span class="pre">TreeNodeMultipleChoiceField</span></code></a></li>
<li><a class="reference internal" href="#treenodepositionfield" id="id6"><code class="docutils literal"><span class="pre">TreeNodePositionField</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#forms" id="id7">Forms</a><ul>
<li><a class="reference internal" href="#movenodeform" id="id8"><code class="docutils literal"><span class="pre">MoveNodeForm</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="fields">
<h2><a class="toc-backref" href="#id3">Fields</a><a class="headerlink" href="#fields" title="Permalink to this headline">¶</a></h2>
<p>The following custom form fields are provided in the <code class="docutils literal"><span class="pre">mptt.forms</span></code>
package.</p>
<div class="section" id="treenodechoicefield">
<h3><a class="toc-backref" href="#id4"><code class="docutils literal"><span class="pre">TreeNodeChoiceField</span></code></a><a class="headerlink" href="#treenodechoicefield" title="Permalink to this headline">¶</a></h3>
<p>This is the default formfield used by <code class="docutils literal"><span class="pre">TreeForeignKey</span></code></p>
<p>A subclass of <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/forms/fields/#django.forms.ModelChoiceField">ModelChoiceField</a> which represents the tree level of
each node when generating option labels.</p>
<p>For example, where a form which used a <code class="docutils literal"><span class="pre">ModelChoiceField</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">category</span> <span class="o">=</span> <span class="n">ModelChoiceField</span><span class="p">(</span><span class="n">queryset</span><span class="o">=</span><span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
</pre></div>
</div>
<p>...would result in a select with the following options:</p>
<div class="highlight-python"><div class="highlight"><pre>---------
Root 1
Child 1.1
Child 1.1.1
Root 2
Child 2.1
Child 2.1.1
</pre></div>
</div>
<p>Using a <code class="docutils literal"><span class="pre">TreeNodeChoiceField</span></code> instead:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">category</span> <span class="o">=</span> <span class="n">TreeNodeChoiceField</span><span class="p">(</span><span class="n">queryset</span><span class="o">=</span><span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
</pre></div>
</div>
<p>...would result in a select with the following options:</p>
<div class="highlight-python"><div class="highlight"><pre>Root 1
--- Child 1.1
------ Child 1.1.1
Root 2
--- Child 2.1
------ Child 2.1.1
</pre></div>
</div>
<p>The text used to indicate a tree level can by customised by providing a
<code class="docutils literal"><span class="pre">level_indicator</span></code> argument:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">category</span> <span class="o">=</span> <span class="n">TreeNodeChoiceField</span><span class="p">(</span><span class="n">queryset</span><span class="o">=</span><span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
                               <span class="n">level_indicator</span><span class="o">=</span><span class="s">u'+--'</span><span class="p">)</span>
</pre></div>
</div>
<p>...which for this example would result in a select with the following
options:</p>
<div class="highlight-python"><div class="highlight"><pre>Root 1
+-- Child 1.1
+--+-- Child 1.1.1
Root 2
+-- Child 2.1
+--+-- Child 2.1.1
</pre></div>
</div>
</div>
<div class="section" id="treenodemultiplechoicefield">
<h3><a class="toc-backref" href="#id5"><code class="docutils literal"><span class="pre">TreeNodeMultipleChoiceField</span></code></a><a class="headerlink" href="#treenodemultiplechoicefield" title="Permalink to this headline">¶</a></h3>
<p>Just like <code class="docutils literal"><span class="pre">TreeNodeChoiceField</span></code>, but accepts more than one value.</p>
</div>
<div class="section" id="treenodepositionfield">
<h3><a class="toc-backref" href="#id6"><code class="docutils literal"><span class="pre">TreeNodePositionField</span></code></a><a class="headerlink" href="#treenodepositionfield" title="Permalink to this headline">¶</a></h3>
<p>A subclass of <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/forms/fields/#choicefield">ChoiceField</a> whose choices default to the valid arguments
for the <a class="reference external" href="models.html#move-to-target-position-first-child">move_to method</a>.</p>
</div>
</div>
<div class="section" id="forms">
<h2><a class="toc-backref" href="#id7">Forms</a><a class="headerlink" href="#forms" title="Permalink to this headline">¶</a></h2>
<p>The following custom form is provided in the <code class="docutils literal"><span class="pre">mptt.forms</span></code> package.</p>
<div class="section" id="movenodeform">
<h3><a class="toc-backref" href="#id8"><code class="docutils literal"><span class="pre">MoveNodeForm</span></code></a><a class="headerlink" href="#movenodeform" title="Permalink to this headline">¶</a></h3>
<p>A form which allows the user to move a given node from one location in
its tree to another, with optional restriction of the nodes which are
valid target nodes for the <cite>move_to method</cite></p>
<div class="section" id="id1">
<h4>Fields<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>The form contains the following fields:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">target</span></code> – a <code class="docutils literal"><span class="pre">TreeNodeChoiceField</span></code> for selecting the target node
for the node movement.</p>
<p>Target nodes will be displayed as a single <code class="docutils literal"><span class="pre">&lt;select&gt;</span></code> with its
<code class="docutils literal"><span class="pre">size</span></code> attribute set, so the user can scroll through the target
nodes without having to open the dropdown list first.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">position</span></code> – a <code class="docutils literal"><span class="pre">TreeNodePositionField</span></code> for selecting the position
of the node movement, related to the target node.</p>
</li>
</ul>
</div>
<div class="section" id="construction">
<h4>Construction<a class="headerlink" href="#construction" title="Permalink to this headline">¶</a></h4>
<p>Required arguments:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">node</span></code></dt>
<dd>When constructing the form, the model instance representing the
node to be moved must be passed as the first argument.</dd>
</dl>
<p>Optional arguments:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">valid_targets</span></code></dt>
<dd><p class="first">If provided, this keyword argument will define the list of nodes
which are valid for selection in form. Otherwise, any instance of the
same model class as the node being moved will be available for
selection, apart from the node itself and any of its descendants.</p>
<p class="last">For example, if you want to restrict the node to moving within its
own tree, pass a <code class="docutils literal"><span class="pre">QuerySet</span></code> containing everything in the node’s
tree except itself and its descendants (to prevent invalid moves) and
the root node (as a user could choose to make the node a sibling of
the root node).</p>
</dd>
<dt><code class="docutils literal"><span class="pre">target_select_size</span></code></dt>
<dd>If provided, this keyword argument will be used to set the size of
the select used for the target node. Defaults to <code class="docutils literal"><span class="pre">10</span></code>.</dd>
<dt><code class="docutils literal"><span class="pre">position_choices</span></code></dt>
<dd>A tuple of allowed position choices and their descriptions.</dd>
<dt><code class="docutils literal"><span class="pre">level_indicator</span></code></dt>
<dd>A string which will be used to represent a single tree level in the
target options.</dd>
</dl>
</div>
<div class="section" id="save-method">
<h4><code class="docutils literal"><span class="pre">save()</span></code> method<a class="headerlink" href="#save-method" title="Permalink to this headline">¶</a></h4>
<p>When the form’s <code class="docutils literal"><span class="pre">save()</span></code> method is called, it will attempt to perform
the node movement as specified in the form.</p>
<p>If an invalid move is attempted, an error message will be added to the
form’s non-field errors (accessible using
<code class="docutils literal"><span class="pre">{{</span> <span class="pre">form.non_field_errors</span> <span class="pre">}}</span></code> in templates) and the associated
<code class="docutils literal"><span class="pre">mptt.exceptions.InvalidMove</span></code> will be re-raised.</p>
<p>It’s recommended that you attempt to catch this error and, if caught,
allow your view to to fall through to rendering the form again again, so
the error message is displayed to the user.</p>
</div>
<div class="section" id="example-usage">
<h4>Example usage<a class="headerlink" href="#example-usage" title="Permalink to this headline">¶</a></h4>
<p>A sample view which shows basic usage of the form is provided below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render_to_response</span>

<span class="kn">from</span> <span class="nn">faqs.models</span> <span class="kn">import</span> <span class="n">Category</span>
<span class="kn">from</span> <span class="nn">mptt.exceptions</span> <span class="kn">import</span> <span class="n">InvalidMove</span>
<span class="kn">from</span> <span class="nn">mptt.forms</span> <span class="kn">import</span> <span class="n">MoveNodeForm</span>

<span class="k">def</span> <span class="nf">move_category</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">category_pk</span><span class="p">):</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">category_pk</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">MoveNodeForm</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">category</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">category</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">())</span>
            <span class="k">except</span> <span class="n">InvalidMove</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">MoveNodeForm</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">'faqs/move_category.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">'form'</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
        <span class="s">'category'</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
        <span class="s">'category_tree'</span><span class="p">:</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
    <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
         </div>
        </body>
       </html>